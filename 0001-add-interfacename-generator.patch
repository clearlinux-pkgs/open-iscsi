From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Dimitri John Ledkov <dimitri.j.ledkov@intel.com>
Date: Mon, 11 May 2015 13:31:36 +0100
Subject: [PATCH] add interfacename generator

Signed-off-by: Patrick McCarty <patrick.mccarty@intel.com>
---
 etc/systemd/iscsi-gen-initiatorname.service | 8 ++++++++
 etc/systemd/iscsid.service                  | 4 ++--
 utils/iscsi-gen-initiatorname               | 4 +++-
 3 files changed, 13 insertions(+), 3 deletions(-)
 create mode 100644 etc/systemd/iscsi-gen-initiatorname.service

diff --git a/etc/systemd/iscsi-gen-initiatorname.service b/etc/systemd/iscsi-gen-initiatorname.service
new file mode 100644
index 0000000..51e6508
--- /dev/null
+++ b/etc/systemd/iscsi-gen-initiatorname.service
@@ -0,0 +1,8 @@
+[Unit]
+Description=iSCSI InitiatorName Generator
+ConditionPathExists=!/etc/iscsi/initiatorname.iscsi
+
+[Service]
+ExecStart=/usr/bin/iscsi-gen-initiatorname
+Type=oneshot
+RemainAfterExit=yes
diff --git a/etc/systemd/iscsid.service b/etc/systemd/iscsid.service
index e2a50d3..b7b8c6e 100644
--- a/etc/systemd/iscsid.service
+++ b/etc/systemd/iscsid.service
@@ -2,9 +2,9 @@
 Description=Open-iSCSI
 Documentation=man:iscsid(8) man:iscsiuio(8) man:iscsiadm(8)
 DefaultDependencies=no
-After=network-online.target iscsiuio.service iscsi-init.service
+After=network-online.target iscsi-gen-initiatorname.service iscsiuio.service iscsi-init.service
 Before=remote-fs-pre.target
-Wants=remote-fs-pre.target
+Wants=remote-fs-pre.target network-online.target iscsi-gen-initiatorname.service
 Requires=iscsi-init.service
 
 [Service]
diff --git a/utils/iscsi-gen-initiatorname b/utils/iscsi-gen-initiatorname
index e182f8a..c9b0d58 100755
--- a/utils/iscsi-gen-initiatorname
+++ b/utils/iscsi-gen-initiatorname
@@ -44,6 +44,8 @@ if [ -d /sys/firmware/ibft/initiator ] ; then
     read iSCSI_INITIATOR_NAME < /sys/firmware/ibft/initiator/initiator-name
 fi
 
+mkdir -p /etc/iscsi
+
 # if we have an iBFT initiator name and an initiator name
 # file, they had better match, unless "force" is set
 if [ -f $INAME_FILE -a -z "$FORCE" ] ; then
@@ -94,7 +96,7 @@ if [ ! -f $INAME_FILE ] ; then
 ## for each iSCSI initiator.  Do NOT duplicate iSCSI InitiatorNames.
 EOF
     # create a unique initiator name using iscsi-iname
-    INAME=$(@SBINDIR@/iscsi-iname -p "$IQN_PREFIX")
+    INAME=$(@SBINDIR@/iscsi-iname)
     echo "InitiatorName=$INAME" >> $INAME_FILE
     chmod 0600 $INAME_FILE
 fi
